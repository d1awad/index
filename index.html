<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arabic ID Card Scanner - Extract All Info</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; }
  video, canvas {
    border: 1px solid #ccc;
    width: 320px; height: 203px; /* horizontal ID card size */
    object-fit: cover;
  }
  #controls { margin-top: 10px; }
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  input, textarea {
    width: 320px;
    font-size: 1.1em;
    padding: 5px;
  }
  textarea {
    height: 150px;
  }
</style>
</head>
<body>

<h2>Arabic ID Card Scanner - Extract All Info</h2>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div id="controls">
  <button id="startBtn">Start Camera</button>
  <button id="captureBtn">Scan Card</button>
</div>

<label>National ID Number:</label>
<input type="text" id="idField" readonly />

<label>Full Name (Arabic):</label>
<input type="text" id="nameField" readonly />

<label>Father's Name (Arabic):</label>
<input type="text" id="fatherField" readonly />

<label>Mother's Name (Arabic):</label>
<input type="text" id="motherField" readonly />

<label>Birthdate:</label>
<input type="text" id="birthField" readonly />

<label>Issue Date:</label>
<input type="text" id="issueField" readonly />

<label>Expiry Date:</label>
<input type="text" id="expiryField" readonly />

<label>Phone Number:</label>
<input type="text" id="phoneField" readonly />

<label>Full OCR Text:</label>
<textarea id="fullText" readonly></textarea>

<script>
  const video = document.getElementById('video');
  let currentStream;

  async function startCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
    }
    try {
      currentStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });
      video.srcObject = currentStream;
    } catch (e) {
      alert('Cannot access rear camera, falling back to any camera.');
      currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      video.srcObject = currentStream;
    }
  }

  function extractDetails(text) {
    // Normalize text by removing extra spaces and lines
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

    // Extract ID Number (digits 6+)
    const idMatch = text.match(/\b\d{6,}\b/);
    const idNumber = idMatch ? idMatch[0] : 'Not found';

    // Extract phone number (digits, +, spaces, dashes)
    const phoneMatch = text.match(/(\+?\d[\d\s\-]{6,}\d)/);
    const phoneNumber = phoneMatch ? phoneMatch[0].replace(/[\s\-]/g, '') : 'Not found';

    // Extract birthdate (simple date pattern DD/MM/YYYY or YYYY/MM/DD)
    const birthMatch = text.match(/(\d{2}\/\d{2}\/\d{4}|\d{4}\/\d{2}\/\d{2})/);
    const birthdate = birthMatch ? birthMatch[0] : 'Not found';

    // Issue date (look for second date after birthdate)
    let issueDate = 'Not found';
    if (birthMatch) {
      const birthIndex = lines.findIndex(line => line.includes(birthMatch[0]));
      if (birthIndex >= 0 && birthIndex + 1 < lines.length) {
        const possibleIssue = lines[birthIndex + 1].match(/(\d{2}\/\d{2}\/\d{4}|\d{4}\/\d{2}\/\d{2})/);
        issueDate = possibleIssue ? possibleIssue[0] : 'Not found';
      }
    }

    // Expiry date (look for third date or near end)
    let expiryDate = 'Not found';
    if (birthMatch) {
      const birthIndex = lines.findIndex(line => line.includes(birthMatch[0]));
      if (birthIndex >= 0 && birthIndex + 2 < lines.length) {
        const possibleExpiry = lines[birthIndex + 2].match(/(\d{2}\/\d{2}\/\d{4}|\d{4}\/\d{2}\/\d{2})/);
        expiryDate = possibleExpiry ? possibleExpiry[0] : 'Not found';
      }
    }

    // Extract Arabic text lines excluding lines with digits (likely names)
    const arabicLines = lines.filter(line => /[\u0600-\u06FF]/.test(line) && !/\d/.test(line));
    // Assume:
    // Name = longest Arabic line
    // Father's name = second longest Arabic line
    // Mother's name = third longest Arabic line (if exists)
    const sortedArabic = arabicLines.sort((a,b) => b.length - a.length);
    const name = sortedArabic[0] || 'Not found';
    const father = sortedArabic[1] || 'Not found';
    const mother = sortedArabic[2] || 'Not found';

    return { idNumber, phoneNumber, birthdate, issueDate, expiryDate, name, father, mother };
  }

  async function captureAndRead() {
    if (!currentStream) {
      alert('Camera not started!');
      return;
    }
    const canvas = document.getElementById('canvas');
    canvas.width = 320;
    canvas.height = 203;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Preprocess image: grayscale + threshold
    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    let data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
      let gray = data[i]*0.3 + data[i+1]*0.59 + data[i+2]*0.11;
      gray = gray > 128 ? 255 : 0;
      data[i] = data[i+1] = data[i+2] = gray;
    }
    ctx.putImageData(imageData, 0, 0);

    const { data: { text } } = await Tesseract.recognize(canvas, 'ara');

    document.getElementById('fullText').value = text;

    const { idNumber, phoneNumber, birthdate, issueDate, expiryDate, name, father, mother } = extractDetails(text);

    document.getElementById('idField').value = idNumber;
    document.getElementById('phoneField').value = phoneNumber;
    document.getElementById('birthField').value = birthdate;
    document.getElementById('issueField').value = issueDate;
    document.getElementById('expiryField').value = expiryDate;
    document.getElementById('nameField').value = name;
    document.getElementById('fatherField').value = father;
    document.getElementById('motherField').value = mother;
  }

  document.getElementById('startBtn').onclick = startCamera;
  document.getElementById('captureBtn').onclick = captureAndRead;
</script>

</body>
</html>
