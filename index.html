<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arabic ID Card Scanner</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 10px;
  }
  video, canvas {
    border: 1px solid #ccc;
    width: 320px;
    height: 203px; /* Horizontal ID card size */
    object-fit: cover;
    transform: rotate(0deg);
  }
  #controls {
    margin-top: 10px;
  }
  input[type=text] {
    width: 320px;
    font-size: 1.2em;
    padding: 5px;
  }
</style>
</head>
<body>

<h2>Arabic ID Card Scanner</h2>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div id="controls">
  <button id="startBtn">Start Camera</button>
  <button id="captureBtn">Scan ID Number</button>
</div>

<input type="text" id="idField" placeholder="Scanned ID number appears here" readonly />

<script>
  const video = document.getElementById('video');
  let currentStream;

  async function startCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
    }
    try {
      currentStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { exact: "environment" }, // Rear camera
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      });
      video.srcObject = currentStream;
    } catch (e) {
      alert('Cannot access rear camera, falling back to any camera.');
      currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      video.srcObject = currentStream;
    }
  }

  async function captureAndRead() {
    if (!currentStream) {
      alert('Camera not started!');
      return;
    }
    const canvas = document.getElementById('canvas');
    // Set canvas size to horizontal ID card size (wider than tall)
    canvas.width = 320;
    canvas.height = 203;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Preprocess: convert to grayscale & increase contrast
    let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    let data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
      // Grayscale formula
      let gray = data[i]*0.3 + data[i+1]*0.59 + data[i+2]*0.11;
      // Increase contrast threshold
      gray = gray > 128 ? 255 : 0;
      data[i] = data[i+1] = data[i+2] = gray;
    }
    ctx.putImageData(imageData, 0, 0);

    // Run OCR with Arabic language and Arabic+Western digits whitelist
    const { data: { text } } = await Tesseract.recognize(canvas, 'ara', {
      tessedit_char_whitelist: '0123456789٠١٢٣٤٥٦٧٨٩'
    });

    // Match Arabic or western digits (6 or more digits)
    const idMatch = text.match(/[\d٠١٢٣٤٥٦٧٨٩]{6,}/);
    if (idMatch) {
      document.getElementById('idField').value = idMatch[0];
    } else {
      alert('No ID number detected. Try again.');
    }
  }

  document.getElementById('startBtn').onclick = startCamera;
  document.getElementById('captureBtn').onclick = captureAndRead;
</script>

</body>
</html>
